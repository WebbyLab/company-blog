<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="The Pain and the Joy of creating isomorphic apps in ReactJS">
    

    <!--Author-->
    
        <meta name="author" content="WebbyLab">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="The Pain and the Joy of creating isomorphic apps in ReactJS"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="The Pain and the Joy of creating isomorphic apps in ReactJS" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Agile developer"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>The Pain and the Joy of creating isomorphic apps in ReactJS - Agile developer</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-9638621-10', 'auto');
        ga('send', 'pageview');

    </script>



    <!-- LEELOO Init -->
    <!-- leeloo init code -->
<script>
window.LEELOO = function(){
    window.LEELOO_INIT = { id: "59049996ac641a00190cb1b4" };
    var js = document.createElement('script');
    js.src = 'https://app.leeloo.ai/init.js';
    document.getElementsByTagName('head')[0].appendChild(js);
}; LEELOO();
</script>
<!-- leeloo init code end -->


    <!-- favicon -->
    
    <link rel="icon" href="/img/favicon.ico">
    
	
</head>


<body>
    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">WebbyLab's Engineering Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a target="_blank" href="https://webbylab.com">
                            
                                Main Company Site
                            
                        </a>
                    </li>
                
                    <li>
                        <a target="_blank" href="https://react.webbylab.com">
                            
                                React/Mobile/Nodejs Department
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Main Content -->
    <!-- LEELOO POPUP -->
<!-- Leeloo popup start -->
<script>
    window.LEELOO_LEADGENTOOLS = (window.LEELOO_LEADGENTOOLS || []).concat('3nqz71');
</script>
<!-- Leeloo popup start -->


<!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/background.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>The Pain and the Joy of creating isomorphic apps in ReactJS</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                            Posted by Viktor Turskyi (CTO) <a href="https://twitter.com/koorchik" rel="nofollow" target=_blank>@koorchik</a> on
                        
                        2015-12-08
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/javascript-team/">#JavaScript Team</a> <a href="/tags/reactjs/">#ReactJS</a> <a href="/tags/redux/">#Redux</a> <a href="/tags/isomorphic/">#Isomorphic</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>This post is not a tutorial. There are enough of them on the Internet. It is always more interesting to look at real production app. A lot of tutorials and boilerplates show how to write isomorphic ReactJS applications, but they do not cover a lot of real-life problems we’ve faced in production. So we decided to share our experience at github and develop the app in a public repo. Here is <a href="http://itsquiz.com/en/activations" target="_blank" rel="noopener">the running app</a> and here is <a href="https://github.com/webbylab/itsquiz-wall" target="_blank" rel="noopener">its code</a>.</p>
<p><strong>IMPORTANT</strong>: This is real-world application, so it is always evolving. Our goal is to make working product within a limited amount of time. Sometimes, we have no time for finding the best possible solution, but use just suitable option for our case.</p>
<h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>Let’s start with the term “Isomorphic application”. An isomorphic JavaScript application is just a JavaScript application that can run both client-side and server-side (in most cases it is a single-page application that can be run on server). I do not like the word “isomorphic”, I believe that programmers should struggle complexity (not only in code) and the word “isomorphic” complicates understanding, therefore it increases complexity :). There is another name for isomorphic JavaScript - “Universal JavaScript”, but in my opinion the word “Universal” is too general. So, in this post, I will use the word “isomorphic” ( even if do not like it :) ).</p>
<p>How do people see an isomorphic app? You can find diagramms in the internet like this one:</p>
<p><img src="/images/isomorphic-react/isomorphic_separated.png" alt=""></p>
<p>But ideally it should look a little bit different:</p>
<p><img src="/images/isomorphic-react/isomorphic_joined.png" alt=""></p>
<p>I mean, not less than 90% of your code should be reused. In large apps it can be even more than 95%.</p>
<p>If you want to develop isomorphic app from scratch, then start with reading this tutorial <a href="https://medium.com/@bananaoomarang/handcrafting-an-isomorphic-redux-application-with-love-40ada4468af4" target="_blank" rel="noopener">“Handcrafting an Isomorphic Redux Application (With Love)”</a>. It is really great!</p>
<h2 id="About-the-app"><a href="#About-the-app" class="headerlink" title="About the app"></a>About the app</h2><p>In <a href="http://webbylab.com" target="_blank" rel="noopener">WebbyLab</a> we use React from the moment it was open sourced by Facebook almost in every our project. We’ve created keynote clone, excel clone, a lot of hybrid mobile applications, UI for a social monitoring system, comment moderation system, ticket booking system, a lot of admin UIs and more. Sometimes we make isomorphic apps too. The fundamental difference between regular SPA and isomorphic SPA is that in isomorphic SPA you will process several requests simultaneously, therefore you should somehow deal with a global user-dependent state (like current language, flux stores state etc).</p>
<p><a href="http://itsquiz.com/en/activations" target="_blank" rel="noopener">itsquiz.com</a> is one of our projects written in ReactJS. itsquiz.com is a cloud testing platform with a lot of amazing features. And one of the key features of the product is a public quizzes catalogue (aka “quizwall”), any user can publish his own tests there and pass others’. For example, you can go there and <a href="http://itsquiz.com/en/activations/5660a8795b8300236895bef5" target="_blank" rel="noopener">test your knowledge of ReactJS</a>.</p>
<p><em>You can watch 1 minute promo video to better understand the idea of the product:</em></p>
<p><a href="http://www.youtube.com/watch?feature=player_embedded&v=eiougg2UhYA
" target="_blank"><img src="http://img.youtube.com/vi/eiougg2UhYA/0.jpg" alt="IMAGE ALT TEXT HERE" width="480" height="320" border="10"></a></p>
<p>Here are key requirements to Quizwall:</p>
<ol>
<li>Content is available without authorization.</li>
<li>It should be indexable by search engines.</li>
<li>It should have social networks sharing features.</li>
<li>It should support different languages.</li>
<li>It should work fast</li>
</ol>
<p>Writing isomorphic application is the simplest and the most suitable solution in this case.</p>
<h2 id="What-parts-of-your-app-should-be-isomorphic"><a href="#What-parts-of-your-app-should-be-isomorphic" class="headerlink" title="What parts of your app should be isomorphic?"></a>What parts of your app should be isomorphic?</h2><ol>
<li>Isomorphic view</li>
<li>Isomorphic styles</li>
<li>Isomorphic routing</li>
<li>Isomorphic data fetching</li>
<li>Isomorphic configuration</li>
<li>Isomorphic localization</li>
</ol>
<p>Let’s go one after another.</p>
<h3 id="Isomorphic-view-Joy-1"><a href="#Isomorphic-view-Joy-1" class="headerlink" title="Isomorphic view (Joy #1)"></a>Isomorphic view (Joy #1)</h3><p>This is the simplest part. It is simple because Facebook developers solved this problem already in ReactJS. The only thing we should do is to take React Js library and use it according to documentation.</p>
<p>Client code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> App      <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;App /&gt;,</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'react-view'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Server code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom/server'</span>;</span><br><span class="line"><span class="keyword">import</span> App      <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> componentHTML = ReactDOM.renderToString(</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> html = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;head&gt;</span></span><br><span class="line"><span class="string">            &lt;title&gt;Quiz Wall&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;/head&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">            &lt;div id="react-view"&gt;<span class="subst">$&#123;componentHTML&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line">res.end(html)</span><br></pre></td></tr></table></figure>
<p>As you see, we just use “ReactDOM.renderToString” instead of “ReactDOM.render”. That’s it. Nothing complex and you can find this in any tutorial.</p>
<h3 id="Isomorphic-styles"><a href="#Isomorphic-styles" class="headerlink" title="Isomorphic styles"></a>Isomorphic styles</h3><p>Usually tutorials omit this. And this is the first place where you start to feel pain ;).</p>
<h4 id="Pain-1-styles-import"><a href="#Pain-1-styles-import" class="headerlink" title="Pain #1: styles import"></a>Pain #1: styles import</h4><p>We use webpack and usually we import component specific styles in component itself. For example, if we have a component named “Footer.jsx” then we will have less file named “Footer.less” in the same folder. And “Footer.jsx” will import “Footer.less”. The component will have class by its name (“Footer”) and all styles will be namespaced by this class.</p>
<p>Here is a small example:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./Footer.less'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Footer</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div className=<span class="string">'Footer'</span>&gt;</span><br><span class="line">                &lt;small&gt;</span><br><span class="line">                    Developed by</span><br><span class="line">                    &lt;a href=<span class="string">'http://webbylab.com'</span> target=<span class="string">'_blank'</span>&gt;</span><br><span class="line">                        WebbyLab</span><br><span class="line">                    &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>small&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Such approach makes our code more modular. Moreover, if we import a component it will automatically import its dependencies (js libs, styles, other assets). Webpack is responsible for handling all file types. So, we have self-contained components.</p>
<p>This approach works great with webpack. But it will not work in pure nodejs, because you cannot import “less” files. So I’ve started looking for a solution.</p>
<p>The first possible one was <a href="https://nodejs.org/api/globals.html#globals_require_extensions" target="_blank" rel="noopener">require.extensions</a> but</p>
<ol>
<li>Feature stability: 0</li>
<li>Status: “deprecated”</li>
<li>Does not work with babel-node. I am not sure why, more investigation required.</li>
</ol>
<p>So, I’ve started looking for another solution. The simplest one was using inline styles.</p>
<p><strong>Inline styles</strong> .</p>
<p>I’ve decided to try inline styles because:</p>
<ol>
<li>Inline styles have no problems with server side import. They can be saved in json files.</li>
<li><a href="https://facebook.github.io/react/tips/inline-styles.html" target="_blank" rel="noopener">React supports inline styles</a></li>
<li>Inline styles solve a lot of CSS issues without hacks - <a href="https://speakerdeck.com/vjeux/react-css-in-js" target="_blank" rel="noopener">React: CSS in JS by vjeux</a></li>
</ol>
<p>There are several issues I’ve faced using them:</p>
<ol>
<li>You should emulate pseudo css attributes like :hover, :active, :focus with JavaScript.</li>
<li>You should manage vendor prefixes by your own</li>
<li>You should emulate media queries with JavaScript</li>
<li>You need to merge styles some way. (with css you usually just mention several classes names)</li>
</ol>
<p>I’ve found a great tool for working with inline styles called <a href="http://projects.formidablelabs.com/radium/" target="_blank" rel="noopener">Radium</a>. It is great tool which solves all mentioned issues if you develop SPA.</p>
<h4 id="Pain-2-automatic-vendor-prefixing-based-on-browser-DOM"><a href="#Pain-2-automatic-vendor-prefixing-based-on-browser-DOM" class="headerlink" title="Pain #2: automatic vendor prefixing based on browser DOM"></a>Pain #2: automatic vendor prefixing based on browser DOM</h4><p>We’ve switched to Radium but when we run our application in isomorphic mode we received strange warnings.</p>
<p><img src="/images/isomorphic-react/markup-error.png" alt=""></p>
<p>“React injected new markup to compensate which works but you have lost many of the benefits of server rendering.” No, I want all the benefits of server rendering. We run the same code on a server and a client, so why react generates different markup? The problem is with Radium automatic vendor prefixing. Radium creates DOM element to detect list of css properties that should have vendor prefixes.</p>
<p>Here is the issue on Github <a href="https://github.com/FormidableLabs/radium/issues/201" target="_blank" rel="noopener">“Prefixing breaks server rendering”</a>. Yes, there is a solution for it now: using Radium’s autoprefixer on client side and detect browser by user-agent and insert different prefixes (with <a href="https://github.com/rofrischmann/inline-style-prefixer" target="_blank" rel="noopener">inline-style-prefixer</a>) for requests from different browser on server. I tried, but that time the solution was not reliable. Maybe now it works better (you can check it by your own :)).</p>
<p>The second problem is that you cannot use media queries. Your server does not have any information about your browser window size, resolution, orientation etc. Here is a related issue <a href="https://github.com/FormidableLabs/radium/issues/53" target="_blank" rel="noopener">https://github.com/FormidableLabs/radium/issues/53</a>.</p>
<p><strong>Solution that works</strong></p>
<p>I’ve decided to switch back to <a href="http://lesscss.org/" target="_blank" rel="noopener">less</a> and <a href="http://getbem.com/" target="_blank" rel="noopener">BEM</a> but with condititional import.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( process.env.BROWSER ) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">'./Footer.less'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Footer</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div className=<span class="string">'Footer'</span>&gt; <span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You see that we are using “require” instead of “import” to make it runtime dependendant, so nodejs will not require it when you run code on server.</p>
<p>One more thing we need to do is to define process.env.BROWSER in our webpack config. It can be done in the following way:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: <span class="string">"./client/app.js"</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">            <span class="string">"process.env"</span>: &#123;</span><br><span class="line">                BROWSER: <span class="built_in">JSON</span>.stringify(<span class="literal">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> ExtractTextPlugin(<span class="string">"[name].css"</span>)</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>You can find whole <a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/webpack.config.js" target="_blank" rel="noopener">production config on github</a>.</p>
<p>Alternative solution is to create a plugin for babel that will just return “{}” on the server. I am not sure that it possible to do. If you can create babel-stub-plugin - it will be awesome.</p>
<p><strong>UPDATE: We’ve switched to the alternative solution after migrating to Babel 6</strong></p>
<p>We use <a href="https://www.npmjs.com/package/babel-plugin-transform-require-ignore" target="_blank" rel="noopener">babel-plugin-transform-require-ignore</a> plugin for Babel 6. Special thanks to @morlay (Morlay Null) for the plugin.</p>
<p>All you need is to configure file extentions that should be ignored by babel in  <a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/.babelrc" target="_blank" rel="noopener">.babelrc</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"env"</span>: &#123;</span><br><span class="line">   <span class="string">"node"</span>: &#123;</span><br><span class="line">     <span class="string">"plugins"</span>: [</span><br><span class="line">       [</span><br><span class="line">         <span class="string">"babel-plugin-transform-require-ignore"</span>, &#123; <span class="string">"extensions"</span>: [<span class="string">".less"</span>, <span class="string">".css"</span>] &#125;</span><br><span class="line">       ]</span><br><span class="line">     ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and set environment variable BABEL_ENV=’node’ before starting your app. So, you can start your app like that <a href="https://github.com/WebbyLab/itsquiz-wall/blob/7fb861ca09a4759b1b3622ab69d0cd610303da8e/package.json#L14" target="_blank" rel="noopener"><code>cross-env BABEL_ENV=&#39;node&#39; nodemon server/runner.js</code></a>.</p>
<h4 id="Pain-3-Material-UI-uses-vendor-prefixing-based-on-browser-DOM"><a href="#Pain-3-Material-UI-uses-vendor-prefixing-based-on-browser-DOM" class="headerlink" title="Pain #3: Material UI uses vendor prefixing based on browser DOM"></a>Pain #3: Material UI uses vendor prefixing based on browser DOM</h4><p>Ok. Let’s go further. We managed our styles. And it seems that the problems with styles are solved. We use <a href="http://material-ui.com/" target="_blank" rel="noopener">Material UI</a> components library for our UI and we like it. But the problem with it is that it uses the same approach to vendor autoprefixing as Radium.</p>
<p>So we had to switch to the Material Design Lite. We use <a href="https://www.npmjs.com/package/react-mdl" target="_blank" rel="noopener">react-mdl</a> wrapper for React.</p>
<p>Great, it seems that we definitely solved all of the problems related to styling… sorry, not this time.</p>
<h4 id="Pain-3-Assets-loading-order"><a href="#Pain-3-Assets-loading-order" class="headerlink" title="Pain #3: Assets loading order"></a>Pain #3: Assets loading order</h4><p>Webpack will generate a javascript bundle for you and will pack all css files to the same bundle. It is not a problem in SPA - you just load the bundle and start your app. With isomorphic SPA everything is not so obvious.</p>
<p>Firstly, it is a good idea to move your bundle.js to the end of markup. In this case, user will not wait untill large (it can be several megabytes) bundle.js is loaded. A browser will render HTML immediately.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Quiz Wall<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-view"</span>&gt;</span>$&#123;componentHTML&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"application/javascript"</span> <span class="attr">src</span>=<span class="string">"/build/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>This works. But moving the bundle.js to the end also moves styles to the end (as they are packed into the same bundle). So, a browser will render markup without CSS and after that it will load bundle.js (with CSS in it) and only after that it will apply styles. In this case, you will get blinking UI.</p>
<p>Therefore, the right way is to split your bundle into two parts and load everything in the following order:</p>
<ol>
<li>Load CSS</li>
<li>Load components HTML markup</li>
<li>Load JS</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Quiz Wall<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/build/bundle.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-view"</span>&gt;</span>$&#123;componentHTML&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"application/javascript"</span> <span class="attr">src</span>=<span class="string">"/build/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>And the cool thing about webpack is that it has a lot of plugins and loaders. We use <a href="https://www.npmjs.com/package/extract-text-webpack-plugin" target="_blank" rel="noopener">extract-text-webpack-plugin</a> to extract css to a separate bundle.</p>
<p>Your config will look similar to this one.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="keyword">var</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">"extract-text-webpack-plugin"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: <span class="string">"./client/app.js"</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> ExtractTextPlugin(<span class="string">"[name].css"</span>)</span><br><span class="line">    ],</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: __dirname + <span class="string">'/public/build/'</span>,</span><br><span class="line">        filename: <span class="string">"bundle.js"</span>,</span><br><span class="line">        publicPath: <span class="string">"build/"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        loaders: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">                loader: ExtractTextPlugin.extract(<span class="string">"style-loader"</span>, <span class="string">"css-loader!autoprefixer-loader!less-loader"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>You can find whole <a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/webpack.config.js" target="_blank" rel="noopener">production webpack config on github</a>.</p>
<h3 id="Isomorphic-routing"><a href="#Isomorphic-routing" class="headerlink" title="Isomorphic routing"></a>Isomorphic routing</h3><h4 id="Joy-2-React-Router"><a href="#Joy-2-React-Router" class="headerlink" title="Joy #2 - React Router"></a>Joy #2 - React Router</h4><p>React router starting from version 1.0.0 works greatly in isomorphic environment. But there are a lot of outdated tutorials written when react-router-1.0.0 was still in beta. Don’t worry, official documentation has <a href="https://github.com/rackt/react-router/blob/master/docs/guides/advanced/ServerRendering.md" target="_blank" rel="noopener">working example of server-side routing</a>.</p>
<h3 id="Isomorphic-data-fetching"><a href="#Isomorphic-data-fetching" class="headerlink" title="Isomorphic data fetching"></a>Isomorphic data fetching</h3><h4 id="Joy-3-Redux"><a href="#Joy-3-Redux" class="headerlink" title="Joy #3 - Redux"></a>Joy #3 - Redux</h4><p><a href="https://github.com/rackt/redux" target="_blank" rel="noopener">Redux</a> is another library that works greatly in isomorphic environment. The main issues with isomorphic apps:</p>
<ol>
<li>Server processes several requests simultaneously. So, you should have isolated state for each request. No singleton flux stores in this case.</li>
<li>You should create new stores for each request.</li>
<li>You should dump all stores states at the end of request processing and pass this states to the browser. So, a browser will be able to fill existing flux stores with received state and rerender React tree.</li>
</ol>
<p>With redux it can be done easily:</p>
<ol>
<li>Just one store</li>
<li>react-redux uses react context to pass request related store way down by react components tree</li>
<li>redux store has convenient API for dumping and restoring store state.</li>
</ol>
<p><a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/server/app.js" target="_blank" rel="noopener">Here you can find working code</a></p>
<h3 id="Data-fetching"><a href="#Data-fetching" class="headerlink" title="Data fetching"></a>Data fetching</h3><p>You should write code that works both on the server and on the client. Usually in SPAs (even not isomorphic) we write API layer which can be used on the server too. This layer is responsible for all communications with the REST API. It can be packed as separate library for using it in third-party projects.</p>
<p>Here is an example that works both on server and on client:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> apiFactory <span class="keyword">from</span> <span class="string">'./api'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> api = apiFactory(&#123;</span><br><span class="line">    apiPrefix: <span class="string">'http://itsquiz.com/api/v1'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Can be use in a following manner</span></span><br><span class="line"><span class="keyword">const</span> promise = api.users.list();</span><br></pre></td></tr></table></figure>
<p>For making http request you can use something like <a href="https://www.npmjs.com/package/axios" target="_blank" rel="noopener">axios</a> but I prefer <a href="https://www.npmjs.com/package/isomorphic-fetch" target="_blank" rel="noopener">isomorphic-fetch</a> which uses <a href="">whatwg-fetch</a> (from Github) in browser or <a href="https://www.npmjs.com/package/node-fetch" target="_blank" rel="noopener">node-fetch</a> on server.<br>“fetch” is a <a href="https://developer.mozilla.org/en/docs/Web/API/Fetch_API" target="_blank" rel="noopener">standard</a> that is already <a href="http://caniuse.com/#search=fetch" target="_blank" rel="noopener">supported by firefox and chrome</a> natively.</p>
<p>It is the easy part. More complex part is not to create api library but to use it in isomorphic environment.</p>
<p><strong>How client usually works</strong></p>
<ol>
<li>React component rendering.</li>
<li>Show loading spinner</li>
<li>Fetch all the component (pgge) dependent data</li>
<li>Update the page (rerender React component with fetched data)</li>
</ol>
<p>So, the idea is simple. A user will wait for data but will not wait for UI response. So, you should render immediately without data and show spinner and show the data when it was fetched.</p>
<p><strong>How server usually works</strong></p>
<ol>
<li>Preload all required data for the page</li>
<li>Render the page (with data) to string</li>
<li>Send HTML markup to client</li>
</ol>
<p>We want to write the same code for two scenarios. How do we handle this?<br>The idea is simple. We use action creators and they trigger data fetching. So, we should describe all page dependencies - action creators that will be used for data fetching.</p>
<p>The isomorphic part of code will look like:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> React               <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; connect &#125;         <span class="keyword">from</span> <span class="string">'react-redux'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; loadActivations &#125; <span class="keyword">from</span> <span class="string">'actions/activations'</span>;</span><br><span class="line"><span class="keyword">import</span> connectDataFetchers <span class="keyword">from</span> <span class="string">'lib/connectDataFetchers.jsx'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ActivationsPage <span class="keyword">from</span> <span class="string">'components/pages/ActivationsPage.jsx'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivationsPageContainer</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;ActivationsPage</span><br><span class="line">                activations = &#123;<span class="keyword">this</span>.props.activations&#125;</span><br><span class="line">                search      = &#123;<span class="keyword">this</span>.props.search&#125;</span><br><span class="line">                onItemClick = &#123;<span class="keyword">this</span>.handleQuizCardClick&#125;</span><br><span class="line">                onSearch    = &#123;<span class="keyword">this</span>.handleSearch&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(&#123;<span class="attr">activations</span> : state.activations&#125;)(</span><br><span class="line">    connectDataFetchers(ActivationsPageContainer, [ loadActivations ])</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>So, you should wrap your component in another one which will be responsible for data fetching. We use “connectDataFetchers” function for it. It takes React component class and array of references to action creators.</p>
<p><strong>How it works?</strong></p>
<p>In browser the wrapper component will call action creators in <strong>componentDidMount</strong> lifecycle hook.  So, it is a common pattern for SPA.</p>
<p><em>IMPORTANT: componentWillMount is not suitable for this because it will be invoked on the client and server. componentDidMount will be invoked only on the client.</em></p>
<p>On the server we do this in a different way. We have a function <a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/server/utils.js#L12" target="_blank" rel="noopener">“fetchComponentsData”</a> which takes an array of components you are going to render and calls static method “fetchData” on each. One important thing is a usage of promises. We use promises to postpone rendering until the required data is fetched and saved to the redux store.</p>
<p>“connectDataFetchers” is extremely simple:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> IS_FIRST_MOUNT_AFTER_LOAD = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connectDataFetchers</span>(<span class="params">Component, actionCreators</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="title">DataFetchersWrapper</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> fetchData(&#123; dispatch, params = &#123;&#125;, query = &#123;&#125; &#125;) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.all(</span><br><span class="line">                actionCreators.map(<span class="function"><span class="params">actionCreator</span> =&gt;</span> dispatch(actionCreator(&#123; params, query &#125;)))</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        componentDidMount() &#123;</span><br><span class="line">            <span class="comment">// If the component is mounted first time</span></span><br><span class="line">            <span class="comment">// do no fetch data as it is already fetched on the server.</span></span><br><span class="line">            <span class="keyword">if</span> (!IS_FIRST_MOUNT_AFTER_LOAD) &#123;</span><br><span class="line">                <span class="keyword">this</span>._fetchDataOnClient();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            IS_FIRST_MOUNT_AFTER_LOAD = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        componentDidUpdate(prevProps) &#123;</span><br><span class="line">            <span class="comment">// Refetch data if url was changed but the component is the same</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> &#123; location &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">            <span class="keyword">const</span> &#123; <span class="attr">location</span>: prevLocation &#125; = prevProps;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> isUrlChanged = (location.pathname !== prevLocation.pathname)</span><br><span class="line">                              || (location.search !== prevLocation.search);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isUrlChanged) &#123;</span><br><span class="line">                <span class="keyword">this</span>._fetchDataOnClient();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _fetchDataOnClient() &#123;</span><br><span class="line">            DataFetchersWrapper.fetchData(&#123;</span><br><span class="line">                dispatch : <span class="keyword">this</span>.props.dispatch,</span><br><span class="line">                params   : <span class="keyword">this</span>.props.params,</span><br><span class="line">                query    : <span class="keyword">this</span>.props.location.query</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        render() &#123;</span><br><span class="line">            <span class="keyword">return</span> (</span><br><span class="line">                &lt;Component &#123;...this.props&#125; /&gt;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/shared/lib/connectDataFetchers.jsx" target="_blank" rel="noopener">Production version</a> a little bit longer. It passes locale information and has propTypes described.</p>
<p>So, on server our code looks like:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// On every request</span></span><br><span class="line"><span class="keyword">const</span> store = configureStore();</span><br><span class="line"></span><br><span class="line">match(&#123; routes, <span class="attr">location</span>: req.url &#125;, (error, redirectLocation, &#123;components, params, location&#125;) =&gt; &#123;</span><br><span class="line">    fetchComponentsData(store.dispatch, components, params, location.query).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> componentHTML = ReactDOM.renderToString(</span><br><span class="line">            &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">                &lt;RoutingContext &#123;...renderProps&#125;/&gt;</span><br><span class="line">            &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        return renderHTML(&#123;</span></span><br><span class="line"><span class="regexp">            componentHTML,</span></span><br><span class="line"><span class="regexp">            initialState: store.getState()</span></span><br><span class="line"><span class="regexp">        &#125;);</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
<p>Here is the whole server app - <a href="https://github.com/WebbyLab/itsquiz-wall/blob/master/server/app.js" target="_blank" rel="noopener">https://github.com/WebbyLab/itsquiz-wall/blob/master/server/app.js</a></p>
<h3 id="Isomorphic-configuration"><a href="#Isomorphic-configuration" class="headerlink" title="Isomorphic configuration"></a>Isomorphic configuration</h3><p>The simplest way it to use “config.json” and require it wherever needed. And you can find that a lot of people are doing so. In my opinion, this is a bad solution for isomorphic SPA.</p>
<p>What wrong with it?</p>
<p>The problem is that when you require “config.json” webpack will pack it into your bundle.</p>
<ol>
<li>You cannot change config without rebuilding the app. It is not an option for me because I want to use the same build on staging and later on production the only difference is configuration options.</li>
<li>You can have inconsistent config state. Backend sees the new one, but frontend does not see changes because the config is packed into the bundle.</li>
</ol>
<p>The solution is to leave config outside the bundle and place it in some sort of global variable that can be set in index.html.</p>
<p>We load out config on the server and return it in index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"react-view"</span>&gt;</span>$&#123;componentHTML&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"application/javascript"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.__CONFIG__ = $&#123;serializeJs(config, &#123; <span class="attr">isJSON</span>: <span class="literal">true</span> &#125;)&#125;;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.__INITIAL_STATE__ = $&#123;serializeJs(initialState, &#123; <span class="attr">isJSON</span>: <span class="literal">true</span> &#125;)&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"application/javascript"</span> <span class="attr">src</span>=<span class="string">"$&#123;config.staticUrl&#125;/static/build/main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><em>IMPORTANT:  Serializing initialState with JSON.stringify will make your application vulnerable to XSS attacks!!! You should use <a href="https://github.com/yahoo/serialize-javascript" target="_blank" rel="noopener">serialize-javascript</a> instead!</em></p>
<p>But depending on a global variable in your code is not a good idea. So, we create “config.js” module that just exports global variable. And our code depends on “config.js” module.  Our “config.js” should be isomorphic, so on the server we just require json file.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.BROWSER) &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = <span class="built_in">window</span>.__CONFIG__;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">'../etc/client-config.json'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>and we use the “config.js” in the following manner in our isomorphic code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> config     <span class="keyword">from</span> <span class="string">'./config'</span>;</span><br><span class="line"><span class="keyword">import</span> apiFactory <span class="keyword">from</span> <span class="string">'./api'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> apiFactory(&#123;</span><br><span class="line">    apiPrefix: config.apiPrefix</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Isomorphic-localization"><a href="#Isomorphic-localization" class="headerlink" title="Isomorphic localization"></a>Isomorphic localization</h3><p>Very few tutorials explain how to deal with localization in a regular SPA. No tutorials at all say how to deal with localization in an isomorphic environment. In general, it is not an issue for most of the developers because there is no need to support other languages except English. But it is really important topic, so I’ve decided to describe localization issues in the separate post. It will be end to end React applications localization guide (including isomorphic issues).</p>
<h2 id="Statistics"><a href="#Statistics" class="headerlink" title="Statistics"></a>Statistics</h2><p>Universal (isomorphic) code - 2396 SLOC (93.3%)<br>Client specific code - 33 SLOC (1.2%)<br>Server specific code - 139 SLOC (5.4%)</p>
<p>While all codebase growths, isomorphic part of the code growths the most. So, code reuse rate will become higher with time.</p>


                
                    <!-- Go to www.addthis.com/dashboard to customize your tools -->
                    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-58f3c2d3d790e137"></script>

                    <!-- Go to www.addthis.com/dashboard to customize your tools -->
                    <div class="addthis_sharing_toolbox"></div>
                
            </div>
        </div>

        <div class="row">
            <!-- LEELOO -->
            <div class="center col-lg-12 col-md-12 col-sm-12">
                <!-- Leeloo form start --> 
<script>
    window.LEELOO_LEADGENTOOLS = (window.LEELOO_LEADGENTOOLS || []).concat('vfgnh4');
</script>
    
<div class="wepster-hash-vfgnh4"></div>
<!-- Leeloo form end -->
            </div>
        </div>

        <div class="row">
            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>Comments:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                        <li>
                            <div class="twitter-footer">
                                
                                    <span class="action-footer">Follow us on twitter to become a better software development expert</span>
                                
                                <a href="https://twitter.com/webbylab" target="_blank">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </div>
                        </li>
                    

                    

                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2019 WebbyLab<br></p>
                <!-- <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p> -->
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'blog-webbylab-com';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


</body>

</html>
